<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>DigiLearn — All-in-One</title>
<style>
:root {
  --bg: #f6fbff; --card: #fff; --accent: #2563eb; --accent-soft: rgba(37,99,235,0.13);
  --text-dark: #0f172a; --muted: #6b7280; --radius: 18px;
  --shadow-soft: 0 8px 24px rgba(16,24,40,0.08);
  --transition: 240ms cubic-bezier(.25,.45,.35,1);
}
body.dark {
  --bg: #1f2937; --card: #111827; --accent: #3b82f6; --accent-soft: rgba(59,130,246,0.13);
  --text-dark: #f9fafb; --muted: #9ca3af;
}
* { box-sizing:border-box; margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; }
html, body { height:100%; background:var(--bg); color:var(--text-dark); display:flex; justify-content:center; align-items:center; padding:20px; }
.hidden { display:none; }
.wrapper { width:100%; max-width:430px; background: var(--card); padding:32px; border-radius: var(--radius); box-shadow: var(--shadow-soft); text-align:center; opacity:1; transition: opacity 0.3s ease, transform 0.3s ease; }
input { width:100%; padding:14px; border-radius:14px; border:1px solid rgba(0,0,0,0.1); font-size:17px; margin-bottom:12px; }
input:focus { border-color: var(--accent); outline:none; box-shadow:0 0 0 3px rgba(37,99,235,0.18); }
.btn-primary { padding:14px; border:none; border-radius:14px; background:var(--accent); color:#fff; font-size:17px; cursor:pointer; font-weight:600; margin-top:10px; }
.btn-secondary { margin-top:10px; padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,0.12); background:#f8fafc; color:var(--text-dark); font-size:16px; cursor:pointer; }
.message { margin-top:18px; font-size:15px; font-weight:500; opacity:0; transition: opacity 0.3s ease, transform 0.3s ease; }
.message.show { opacity:1; transform:translateY(0); }
.success { color:#059669; }
.error { color:#dc2626; }

/* Splash specific */
.splash { width:100%; max-width:420px; background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.95)); border-radius:24px; box-shadow: var(--shadow-soft); padding:32px; display:flex; flex-direction:column; align-items:center; gap:18px; text-align:center; opacity:1; transition: opacity 0.5s ease; }
.spinner{ width:64px; height:64px; border:6px solid rgba(99,102,241,0.12); border-top-color: var(--accent); border-radius:50%; animation:spin 1.05s linear infinite; margin-bottom:14px; }
@keyframes spin { to { transform: rotate(360deg); } }

</style>
</head>
<body>

<!-- Splash Screen -->
<section id="splash" class="splash">
  <div class="logo"><img src="logo.png" alt="DigiLearn Logo" style="width:70%;"></div>
  <h1 class="title">DigiLearn <span class="dot" style="width:8px;height:8px;background:var(--accent);border-radius:50%;display:inline-block;"></span></h1>
  <div class="spinner"></div>
  <p class="tagline">Loading your learning experience…</p>
</section>

<!-- Login/Welcome -->
<section id="loginSection" class="wrapper hidden">
  <div class="title">Welcome to DigiLearn</div>
  <form id="loginForm">
    <input type="text" id="loginUsername" placeholder="Username or Email" required>
    <input type="password" id="loginPassword" placeholder="Password" required>
    <button class="btn-primary" type="submit">Login</button>
  </form>
  <div id="loginMsg" class="message"></div>
  <button class="btn-secondary" id="toSignupBtn">Create Account</button>
  <button class="btn-secondary" id="toForgotBtn">Forgot Password?</button>
</section>

<!-- Signup -->
<section id="signupSection" class="wrapper hidden">
  <h1>Create your DigiLearn account</h1>
  <form id="signupForm" novalidate>
    <input id="signupUsername" type="text" placeholder="Username (unique)" required>
    <input id="signupEmail" type="email" placeholder="Email (optional)">
    <input id="signupPassword" type="password" placeholder="Password (min 6)" required>
    <input id="signupConfirm" type="password" placeholder="Confirm password" required>
    <div>Security Question #1</div>
    <input id="signupQ1" placeholder="Enter security question #1" required>
    <input id="signupA1" placeholder="Answer #1" required>
    <div>Security Question #2</div>
    <input id="signupQ2" placeholder="Enter security question #2" required>
    <input id="signupA2" placeholder="Answer #2" required>
    <button class="btn-primary" type="submit">Create account</button>
  </form>
  <div id="signupMsg" class="message"></div>
  <button class="btn-secondary" id="toLoginFromSignup">Back to Login</button>
</section>

<!-- Forgot Password -->
<section id="forgotSection" class="wrapper hidden">
  <div class="title">Reset Your Password</div>
  <input id="forgotUsername" placeholder="Username or Email">
  <button class="btn-primary" id="checkUserBtn">Next</button>
  <div id="questionsBox" class="hidden">
    <div id="question1"></div>
    <input id="answer1" placeholder="Answer #1">
    <div id="question2"></div>
    <input id="answer2" placeholder="Answer #2">
    <button class="btn-primary" id="verifyBtn">Verify Answers</button>
  </div>
  <div id="resetBox" class="hidden">
    <input id="newPass" type="password" placeholder="New Password">
    <button class="btn-primary" id="resetBtn">Reset Password</button>
  </div>
  <div id="forgotMsg" class="message"></div>
  <button class="btn-secondary" id="toLoginFromForgot">Back to Login</button>
</section>

<!-- Dashboard/Profile -->
<section id="dashboardSection" class="wrapper hidden">
  <div class="title">Dashboard</div>
  <p id="welcomeUser">Welcome, User!</p>
  <button class="btn-primary" id="logoutBtn">Logout</button>
</section>

<script type="module">
import { getUser, setSession, initDB, userExists, createUser, updateUser } from './auth_v6_1.js';

// Utility
const showSection = (id) => {
  document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
const showMessage = (el, text, type='error') => {
  el.className='message';
  void el.offsetWidth;
  el.textContent=text;
  el.classList.add('show', type);
}

// ---------------- Splash to Login ----------------
setTimeout(() => { showSection('loginSection'); }, 3000); // 3s splash

// ---------------- Navigation ----------------
document.getElementById('toSignupBtn').onclick = ()=> showSection('signupSection');
document.getElementById('toForgotBtn').onclick = ()=> showSection('forgotSection');
document.getElementById('toLoginFromSignup').onclick = ()=> showSection('loginSection');
document.getElementById('toLoginFromForgot').onclick = ()=> showSection('loginSection');

// ---------------- Login ----------------
const loginForm = document.getElementById('loginForm');
const loginMsg = document.getElementById('loginMsg');
loginForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const usernameOrEmail = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  if(!usernameOrEmail||!password) return showMessage(loginMsg,'Please fill in all fields');
  await initDB();
  try {
    const user = await getUser(usernameOrEmail);
    if(!user) return showMessage(loginMsg,'User not found');
    if(user.password!==password) return showMessage(loginMsg,'Incorrect password');
    await setSession(user.username);
    document.getElementById('welcomeUser').textContent = `Welcome, ${user.username}!`;
    showSection('dashboardSection');
  } catch(err) { console.error(err); showMessage(loginMsg,'Login failed'); }
});

// ---------------- Signup ----------------
const signupForm = document.getElementById('signupForm');
const signupMsg = document.getElementById('signupMsg');
signupForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const username = document.getElementById('signupUsername').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;
  const confirm = document.getElementById('signupConfirm').value;
  const q1 = document.getElementById('signupQ1').value.trim();
  const a1 = document.getElementById('signupA1').value.trim();
  const q2 = document.getElementById('signupQ2').value.trim();
  const a2 = document.getElementById('signupA2').value.trim();

  if(!username) return showMessage(signupMsg,'Please choose username');
  if(password.length<6) return showMessage(signupMsg,'Password too short');
  if(password!==confirm) return showMessage(signupMsg,'Passwords do not match');
  if(!q1||!q2||!a1||!a2) return showMessage(signupMsg,'Fill security questions');

  if(await userExists(username)) return showMessage(signupMsg,'Username exists');
  const result = await createUser({username,email,password,q1,a1,q2,a2,created:Date.now()});
  if(!result.success) return showMessage(signupMsg,result.message||'Signup failed');
  showMessage(signupMsg,'Account created successfully','success');
  setTimeout(()=> showSection('loginSection'),900);
});

// ---------------- Forgot Password ----------------
let currentUser = null;
const forgotMsg = document.getElementById('forgotMsg');
document.getElementById('checkUserBtn').onclick = async () => {
  const uname = document.getElementById('forgotUsername').value.trim();
  if(!uname) return showMessage(forgotMsg,'Enter username');
  await initDB();
  currentUser = await getUser(uname);
  if(!currentUser) return showMessage(forgotMsg,'User not found');
  document.getElementById('question1').textContent = currentUser.q1;
  document.getElementById('question2').textContent = currentUser.q2;
  document.getElementById('questionsBox').classList.remove('hidden');
  showMessage(forgotMsg,'Answer your security questions','success');
}
document.getElementById('verifyBtn').onclick = ()=>{
  if(!currentUser) return showMessage(forgotMsg,'No user selected');
  const a1 = document.getElementById('answer1').value.trim().toLowerCase();
  const a2 = document.getElementById('answer2').value.trim().toLowerCase();
  if(a1!==currentUser.a1.toLowerCase()||a2!==currentUser.a2.toLowerCase()) return showMessage(forgotMsg,'Incorrect answers');
  document.getElementById('resetBox').classList.remove('hidden');
  showMessage(forgotMsg,'Verification successful','success');
}
document.getElementById('resetBtn').onclick = async ()=>{
  if(!currentUser) return showMessage(forgotMsg,'No user selected');
  const newPass = document.getElementById('newPass').value.trim();
  if(newPass.length<6) return showMessage(forgotMsg,'Password too short');
  currentUser.password = newPass;
  await updateUser(currentUser);
  showMessage(forgotMsg,'Password updated!','success');
  setTimeout(()=> showSection('loginSection'),1500);
}

// ---------------- Dashboard ----------------
document.getElementById('logoutBtn').onclick = ()=>{
  setSession(null);
  showSection('loginSection');
}
</script>
</body>
      </html>
