<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>DigiLearn â€” Dashboard</title>
<style>
:root {
  --bg:#f6fbff; --card:#fff; --accent:#2563eb; --text:#0f172a; --muted:#6b7280;
  --radius:18px; --shadow:0 8px 24px rgba(16,24,40,0.08); --transition:240ms cubic-bezier(.25,.45,.35,1);
}
body.dark {
  --bg:#1f2937; --card:#111827; --accent:#3b82f6; --text:#f9fafb; --muted:#9ca3af;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
html,body{height:100%;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
body{display:flex;flex-direction:column;align-items:center;padding:20px;min-height:100vh}
.wrapper{
  width:100%;max-width:720px;background:var(--card);border-radius:var(--radius);
  padding:32px 28px;box-shadow:var(--shadow);text-align:center;
}
h1{margin-bottom:16px}
.message{margin-top:12px;font-weight:600}
.btn{padding:12px 24px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-size:16px;cursor:pointer;margin-top:14px;transition:transform .15s ease}
.btn:active{transform:scale(0.97)}
</style>
</head>
<body>

<div class="wrapper">
  <h1>Welcome, <span id="usernameDisplay"></span>!</h1>
  <p>This is your DigiLearn Dashboard.</p>
  <div id="msg" class="message"></div>
  <button id="logoutBtn" class="btn">Logout</button>
</div>

<script type="module">
import { initDB, getUser, updateUser } from './auth_v6_1.js';

const $ = id => document.getElementById(id);
const usernameDisplay = $('usernameDisplay');
const msgEl = $('msg');

function showMessage(text, type='error'){
  msgEl.textContent = text;
  msgEl.style.color = type==='error' ? '#dc2626' : '#059669';
}

// ---------------------------
// IndexedDB session helpers
// ---------------------------
async function getCurrentUser() {
  const db = await initDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction('settings','readonly');
    const store = tx.objectStore('settings');
    const req = store.get('currentUser');
    req.onsuccess = ()=> resolve(req.result?.value || null);
    req.onerror = ()=> reject(req.error);
  });
}

async function setCurrentUser(username) {
  const db = await initDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction('settings','readwrite');
    const store = tx.objectStore('settings');
    const req = store.put({key:'currentUser', value: username});
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
  });
}

async function clearCurrentUser() {
  const db = await initDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction('settings','readwrite');
    const store = tx.objectStore('settings');
    const req = store.delete('currentUser');
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
  });
}

// ---------------------------
// Initialize dashboard
// ---------------------------
async function initDashboard(){
  const username = await getCurrentUser();
  if(!username){
    showMessage('No active session. Redirecting...', 'error');
    setTimeout(()=> window.location.href='welcome.html', 800);
    return;
  }

  const user = await getUser(username);
  if(!user){
    showMessage('User not found. Redirecting...', 'error');
    setTimeout(()=> window.location.href='welcome.html', 800);
    return;
  }

  usernameDisplay.textContent = user.username;

  // Optional: handle dark mode preference
  const darkMode = (await dbTransactionGet('settings', `${user.username}_darkMode`));
  if(darkMode==='true') document.body.classList.add('dark');
}

// ---------------------------
// Helper to get any key from settings
// ---------------------------
async function dbTransactionGet(storeName,key){
  const db = await initDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(storeName,'readonly');
    const store = tx.objectStore(storeName);
    const req = store.get(key);
    req.onsuccess = ()=> resolve(req.result?.value || null);
    req.onerror = ()=> reject(req.error);
  });
}

// ---------------------------
// Logout event
// ---------------------------
$('logoutBtn').addEventListener('click', async ()=>{
  await clearCurrentUser();
  window.location.href = 'welcome.html';
});

// ---------------------------
// Start
// ---------------------------
initDashboard();
</script>

</body>
</html>
