<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>DigiLearn â€” Dashboard</title>
<style>
:root {
  --bg:#f6fbff; --card:#fff; --accent:#2563eb; --text:#0f172a; --muted:#6b7280;
  --radius:18px; --shadow:0 8px 24px rgba(16,24,40,0.08); --transition:240ms cubic-bezier(.25,.45,.35,1);
}
body.dark {
  --bg:#1f2937; --card:#111827; --accent:#3b82f6; --text:#f9fafb; --muted:#9ca3af;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
html,body{height:100%;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
body{display:flex;flex-direction:column;align-items:center;padding:20px;min-height:100vh}
.wrapper{
  width:100%;max-width:720px;background:var(--card);border-radius:var(--radius);
  padding:32px 28px;box-shadow:var(--shadow);text-align:center;
}
h1{margin-bottom:16px}
.message{margin-top:12px;font-weight:600}
.btn{padding:12px 24px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-size:16px;cursor:pointer;margin-top:14px;transition:transform .15s ease}
.btn:active{transform:scale(0.97)}
</style>
</head>
<body>

<div class="wrapper">
  <h1>Welcome, <span id="usernameDisplay"></span>!</h1>
  <p>This is your DigiLearn Dashboard.</p>
  <div id="msg" class="message"></div>
  <button id="logoutBtn" class="btn">Logout</button>
</div>

<script type="module">
import { initDB } from './auth_v6_1.js';

const $ = id => document.getElementById(id);
const usernameDisplay = $('usernameDisplay');
const msgEl = $('msg');

function showMessage(text, type='error'){
  msgEl.textContent = text;
  msgEl.style.color = type==='error' ? '#dc2626' : '#059669';
}

// ---------------------------
// Get active session from IndexedDB
// ---------------------------
async function getActiveSession(){
  await initDB(); // ensure DB exists
  return new Promise((resolve, reject)=>{
    const request = indexedDB.open('DigiLearnDB', 1);

    request.onerror = () => reject('Failed to open DB');
    request.onsuccess = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains('session')){
        return resolve(null);
      }
      const tx = db.transaction('session', 'readonly');
      const store = tx.objectStore('session');
      const getReq = store.get('activeUser');
      getReq.onsuccess = ()=> resolve(getReq.result || null);
      getReq.onerror = ()=> resolve(null);
    };
  });
}

// ---------------------------
// Logout function
// ---------------------------
async function clearSession(){
  return new Promise((resolve, reject)=>{
    const request = indexedDB.open('DigiLearnDB', 1);
    request.onerror = () => reject('Failed to open DB');
    request.onsuccess = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains('session')){
        return resolve(true);
      }
      const tx = db.transaction('session', 'readwrite');
      const store = tx.objectStore('session');
      const delReq = store.delete('activeUser');
      delReq.onsuccess = ()=> resolve(true);
      delReq.onerror = ()=> reject('Failed to clear session');
    };
  });
}

// ---------------------------
// Initialize dashboard
// ---------------------------
async function initDashboard(){
  const session = await getActiveSession();
  if(!session || !session.username){
    showMessage('No active session. Redirecting...', 'error');
    setTimeout(()=> window.location.href='welcome.html', 800);
    return;
  }
  usernameDisplay.textContent = session.username;
}

// ---------------------------
// Event listeners
// ---------------------------
$('logoutBtn').addEventListener('click', async ()=>{
  await clearSession();
  window.location.href = 'welcome.html';
});

// ---------------------------
// Start
// ---------------------------
initDashboard();
</script>

</body>
</html>
